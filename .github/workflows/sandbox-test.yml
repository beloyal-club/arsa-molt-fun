name: Sandbox Test

on:
  push:
    branches:
      - 'feature/**'
      - 'sandbox/**'
  workflow_dispatch:
    inputs:
      code:
        description: 'Code to execute in sandbox'
        required: false
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type check
        run: npm run typecheck
      
      - name: Run tests
        run: npm test
      
      - name: Build
        run: npm run build
      
      - name: Report results
        if: always()
        run: |
          echo "## Sandbox Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ All checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some checks failed" >> $GITHUB_STEP_SUMMARY
          fi

  codemode-sandbox:
    if: github.event.inputs.code != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Execute in sandbox
        run: |
          # Create isolated sandbox directory
          mkdir -p /tmp/sandbox
          cd /tmp/sandbox
          
          # Write the code to execute
          cat << 'SANDBOX_CODE' > index.mjs
          ${{ github.event.inputs.code }}
          SANDBOX_CODE
          
          # Execute with timeout and resource limits
          timeout 30s node --experimental-vm-modules index.mjs || echo "Execution completed or timed out"
      
      - name: Report sandbox results
        if: always()
        run: |
          echo "## Codemode Sandbox Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Code executed in isolated sandbox" >> $GITHUB_STEP_SUMMARY
